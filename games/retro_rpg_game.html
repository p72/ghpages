<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>80å¹´ä»£é¢¨RPG - ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ãƒ»ã‚¯ã‚¨ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #000020;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            font-size: 14px;
        }
        
        .game-container {
            display: flex;
            gap: 20px;
            max-width: 1200px;
        }
        
        .left-panel {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .game-log {
            background-color: #001133;
            border: 2px solid #00ff00;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .input-area {
            background-color: #001133;
            border: 2px solid #00ff00;
            padding: 10px;
        }
        
        .map-display {
            background-color: #001133;
            border: 2px solid #00ff00;
            padding: 10px;
            font-family: monospace;
            font-size: 16px;
            line-height: 1.2;
            margin-bottom: 10px;
        }
        
        .right-panel {
            flex: 1;
            background-color: #001133;
            border: 2px solid #00ff00;
            padding: 15px;
        }
        
        .status-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 10px;
        }
        
        .status-section h3 {
            color: #ffff00;
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .stat-bar {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        
        .equipment-slot {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px;
            background-color: #000044;
            border: 1px solid #0066ff;
        }
        
        button {
            background-color: #0066ff;
            color: white;
            border: 2px solid #00aaff;
            padding: 8px 15px;
            margin: 3px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        button:hover {
            background-color: #0088ff;
        }
        
        button:disabled {
            background-color: #333;
            color: #666;
            cursor: not-allowed;
        }
        
        .command-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .hp-bar, .mp-bar {
            width: 100%;
            height: 15px;
            background-color: #330000;
            border: 1px solid #666;
            margin: 5px 0;
        }
        
        .hp-fill {
            height: 100%;
            background-color: #ff0000;
            transition: width 0.3s;
        }
        
        .mp-fill {
            height: 100%;
            background-color: #0000ff;
            transition: width 0.3s;
        }
        
        .combat-area {
            background-color: #330000;
            border: 2px solid #ff0000;
            padding: 10px;
            margin: 10px 0;
            display: none;
        }
        
        .combat-area.active {
            display: block;
        }
        
        .monster-info {
            color: #ff8888;
            margin-bottom: 10px;
        }
        
        .equipment-menu {
            background-color: #001133;
            border: 2px solid #ffff00;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }
        
        .equipment-menu.active {
            display: block;
        }
        
        .equipment-menu h3 {
            color: #ffff00;
            margin: 0 0 15px 0;
        }
        
        .new-item-stats {
            background-color: #003300;
            border: 1px solid #00ff00;
            padding: 10px;
            margin: 10px 0;
        }
        
        .stat-comparison {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        
        .stat-up {
            color: #00ff00;
        }
        
        .stat-down {
            color: #ff6666;
        }
        
        .equip-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .magic-menu {
            background-color: #000044;
            border: 2px solid #0088ff;
            padding: 15px;
            margin: 10px 0;
            display: none;
        }
        
        .magic-menu.active {
            display: block;
        }
        
        .magic-menu h3 {
            color: #0088ff;
            margin: 0 0 15px 0;
        }
        
        .spell-option {
            background-color: #001166;
            border: 1px solid #0088ff;
            padding: 8px;
            margin: 5px 0;
            cursor: pointer;
        }
        
        .spell-option:hover {
            background-color: #002288;
        }
        
        .spell-option.disabled {
            background-color: #333;
            color: #666;
            cursor: not-allowed;
        }
        
        .spell-cost {
            color: #88aaff;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; color: #ffff00;">âš”ï¸ ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ãƒ»ã‚¯ã‚¨ã‚¹ãƒˆ âš”ï¸</h1>
    
    <div class="game-container">
        <div class="left-panel">
            <div class="map-display" id="mapDisplay"></div>
            <div class="game-log" id="gameLog"></div>
            <div class="combat-area" id="combatArea">
                <div class="monster-info" id="monsterInfo"></div>
                <div class="command-buttons">
                    <button onclick="attack()">ãŸãŸã‹ã†</button>
                    <button onclick="magic()">ã¾ã»ã†</button>
                    <button onclick="useItem()">ã©ã†ã</button>
                    <button onclick="flee()">ã«ã’ã‚‹</button>
                </div>
            </div>
            <div class="equipment-menu" id="equipmentMenu">
                <h3>è£…å‚™å¤‰æ›´</h3>
                <div id="newItemDisplay"></div>
                <div class="equip-buttons">
                    <button onclick="equipItem('weapon')">æ­¦å™¨ã«è£…å‚™</button>
                    <button onclick="equipItem('armor')">é˜²å…·ã«è£…å‚™</button>
                    <button onclick="equipItem('accessory1')">ã‚¢ã‚¯ã‚»1ã«è£…å‚™</button>
                    <button onclick="equipItem('accessory2')">ã‚¢ã‚¯ã‚»2ã«è£…å‚™</button>
                    <button onclick="discardItem()">æ¨ã¦ã‚‹</button>
                    <button onclick="closeEquipMenu()">é–‰ã˜ã‚‹</button>
                </div>
            </div>
            <div class="magic-menu" id="magicMenu">
                <h3>é­”æ³•é¸æŠ</h3>
                <div class="spell-option" onclick="castSpell('fire')">
                    <strong>ãƒ•ã‚¡ã‚¤ã‚¢</strong> <span class="spell-cost">(MP: 5)</span><br>
                    æ•µã«ç‚ã®é­”æ³•æ”»æ’ƒã‚’æ”¾ã¤
                </div>
                <div class="spell-option" onclick="castSpell('heal')">
                    <strong>ãƒ’ãƒ¼ãƒ«</strong> <span class="spell-cost">(MP: 3)</span><br>
                    HPã‚’å›å¾©ã™ã‚‹
                </div>
                <div class="spell-option" onclick="castSpell('thunder')">
                    <strong>ã‚µãƒ³ãƒ€ãƒ¼</strong> <span class="spell-cost">(MP: 8)</span><br>
                    æ•µã«å¼·åŠ›ãªé›·æ’ƒã‚’æ”¾ã¤
                </div>
                <button onclick="closeMagicMenu()" style="margin-top: 10px;">é–‰ã˜ã‚‹</button>
            </div>
            <div class="input-area">
                <div class="command-buttons" id="movementButtons">
                    <button onclick="move('north')">åŒ—ã¸</button>
                    <button onclick="move('south')">å—ã¸</button>
                    <button onclick="move('east')">æ±ã¸</button>
                    <button onclick="move('west')">è¥¿ã¸</button>
                    <button onclick="searchRoom()">èª¿ã¹ã‚‹</button>
                    <button onclick="magic()">ã¾ã»ã†</button>
                    <button onclick="showInventory()">è£…å‚™</button>
                </div>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="status-section">
                <h3>å‹‡è€…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
                <div class="stat-bar">
                    <span>ãƒ¬ãƒ™ãƒ«:</span>
                    <span id="level">1</span>
                </div>
                <div class="stat-bar">
                    <span>çµŒé¨“å€¤:</span>
                    <span id="exp">0/100</span>
                </div>
                <div>
                    HP: <span id="hp">50/50</span>
                    <div class="hp-bar">
                        <div class="hp-fill" id="hpFill" style="width: 100%"></div>
                    </div>
                </div>
                <div>
                    MP: <span id="mp">20/20</span>
                    <div class="mp-bar">
                        <div class="mp-fill" id="mpFill" style="width: 100%"></div>
                    </div>
                </div>
                <div class="stat-bar">
                    <span>ç‰©ç†åŠ›:</span>
                    <span id="attack">15</span>
                </div>
                <div class="stat-bar">
                    <span>é­”æ³•åŠ›:</span>
                    <span id="magic">8</span>
                </div>
            </div>
            
            <div class="status-section">
                <h3>è£…å‚™</h3>
                <div class="equipment-slot">
                    <span>æ­¦å™¨:</span>
                    <span id="weapon">ãªã—</span>
                </div>
                <div class="equipment-slot">
                    <span>é˜²å…·:</span>
                    <span id="armor">ãªã—</span>
                </div>
                <div class="equipment-slot">
                    <span>ã‚¢ã‚¯ã‚»1:</span>
                    <span id="accessory1">ãªã—</span>
                </div>
                <div class="equipment-slot">
                    <span>ã‚¢ã‚¯ã‚»2:</span>
                    <span id="accessory2">ãªã—</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = {
            player: {
                level: 1,
                hp: 60,
                maxHp: 60,
                mp: 25,
                maxMp: 25,
                baseAttack: 12,
                baseMagic: 10,
                exp: 0,
                expToNext: 100,
                x: 2,
                y: 4,
                equipment: {
                    weapon: null,
                    armor: null,
                    accessory1: null,
                    accessory2: null
                }
            },
            dungeon: [],
            inCombat: false,
            currentMonster: null,
            gameLog: [],
            inventory: [],
            showingEquipMenu: false,
            showingMagicMenu: false
        };

        // ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
        const monsters = [
            {name: "ã‚¹ãƒ©ã‚¤ãƒ ", hp: 25, mp: 0, attack: 8, magic: 0, exp: 15, dropRate: 0.3},
            {name: "ã‚´ãƒ–ãƒªãƒ³", hp: 35, mp: 5, attack: 12, magic: 3, exp: 25, dropRate: 0.4},
            {name: "ã‚ªãƒ¼ã‚¯", hp: 55, mp: 10, attack: 18, magic: 5, exp: 40, dropRate: 0.5},
            {name: "ã‚¹ã‚±ãƒ«ãƒˆãƒ³", hp: 45, mp: 15, attack: 15, magic: 8, exp: 35, dropRate: 0.45},
            {name: "ãƒ‰ãƒ©ã‚´ãƒ³(ãƒœã‚¹)", hp: 120, mp: 30, attack: 25, magic: 15, exp: 200, dropRate: 1.0}
        ];

        // è£…å‚™ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¨åŸºæœ¬è£…å‚™
        const prefixes = [
            {name: "ãƒœãƒ­ãƒœãƒ­ã®", hp: -2, mp: 0, attack: -1, magic: 0},
            {name: "æ™®é€šã®", hp: 0, mp: 0, attack: 0, magic: 0},
            {name: "é‹­ã„", hp: 0, mp: 0, attack: 3, magic: 0},
            {name: "é ‘ä¸ˆãª", hp: 5, mp: 0, attack: 0, magic: 0},
            {name: "é­”åŠ›ã®", hp: 0, mp: 5, attack: 0, magic: 3},
            {name: "ä¼èª¬ã®", hp: 8, mp: 8, attack: 5, magic: 5}
        ];

        const baseEquipment = {
            weapon: [{name: "çŸ­å‰£", attack: 5}, {name: "å‰£", attack: 8}, {name: "æ–§", attack: 10}],
            armor: [{name: "æœ", hp: 5}, {name: "é©é§", hp: 12}, {name: "é‰„é§", hp: 20}],
            accessory: [{name: "æŒ‡è¼ª", hp: 3, magic: 2}, {name: "é¦–é£¾ã‚Š", mp: 8}, {name: "è…•è¼ª", attack: 3}]
        };

        // åˆæœŸè£…å‚™å®šç¾©
        const startingEquipment = {
            weapon: {
                type: 'weapon',
                displayName: 'æœ¨ã®å‰£',
                hp: 0,
                mp: 0,
                attack: 8,
                magic: 0
            },
            armor: {
                type: 'armor', 
                displayName: 'å¸ƒã®æœ',
                hp: 10,
                mp: 2,
                attack: 0,
                magic: 1
            },
            accessory: {
                type: 'accessory',
                displayName: 'é©ã®è…•è¼ª',
                hp: 5,
                mp: 0,
                attack: 2,
                magic: 0
            }
        };

        // ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ç”Ÿæˆï¼ˆ5x5ï¼‰
        function generateDungeon() {
            const dungeon = [];
            for (let y = 0; y < 5; y++) {
                dungeon[y] = [];
                for (let x = 0; x < 5; x++) {
                    let cell = {
                        visited: false,
                        hasMonster: Math.random() < 0.3,
                        hasTreasure: Math.random() < 0.1,
                        isBossRoom: false
                    };
                    
                    // ãƒœã‚¹éƒ¨å±‹ã¯å³ä¸Šã«é…ç½®
                    if (x === 4 && y === 0) {
                        cell.isBossRoom = true;
                        cell.hasMonster = true;
                        cell.hasTreasure = false;
                    }
                    
                    // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹
                    if (x === 2 && y === 4) {
                        cell.hasMonster = false;
                        cell.visited = true;
                    }
                    
                    dungeon[y][x] = cell;
                }
            }
            return dungeon;
        }

        // ãƒãƒƒãƒ—è¡¨ç¤º
        function displayMap() {
            const map = [];
            for (let y = 0; y < 5; y++) {
                let row = "";
                for (let x = 0; x < 5; x++) {
                    if (x === gameState.player.x && y === gameState.player.y) {
                        row += "[@]";
                    } else if (gameState.dungeon[y][x].visited) {
                        if (gameState.dungeon[y][x].isBossRoom) {
                            row += "[B]";
                        } else {
                            row += "[ ]";
                        }
                    } else {
                        row += "[?]";
                    }
                }
                map.push(row);
            }
            
            document.getElementById('mapDisplay').innerHTML = 
                "=== ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ãƒãƒƒãƒ— ===<br>" + 
                map.join('<br>') + 
                "<br>[@]=å‹‡è€… [B]=ãƒœã‚¹ [?]=æœªæ¢ç´¢";
        }

        // ãƒ­ã‚°è¿½åŠ 
        function addLog(message) {
            gameState.gameLog.push(message);
            const logElement = document.getElementById('gameLog');
            logElement.innerHTML += message + '<br>';
            logElement.scrollTop = logElement.scrollHeight;
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateDisplay() {
            const player = gameState.player;
            const totalStats = calculateTotalStats();
            
            document.getElementById('level').textContent = player.level;
            document.getElementById('exp').textContent = `${player.exp}/${player.expToNext}`;
            document.getElementById('hp').textContent = `${player.hp}/${player.maxHp}`;
            document.getElementById('mp').textContent = `${player.mp}/${player.maxMp}`;
            document.getElementById('attack').textContent = totalStats.attack;
            document.getElementById('magic').textContent = totalStats.magic;
            
            // HPãƒãƒ¼
            const hpPercent = (player.hp / player.maxHp) * 100;
            document.getElementById('hpFill').style.width = hpPercent + '%';
            
            // MPãƒãƒ¼
            const mpPercent = (player.mp / player.maxMp) * 100;
            document.getElementById('mpFill').style.width = mpPercent + '%';
            
            // è£…å‚™è¡¨ç¤º
            document.getElementById('weapon').textContent = 
                player.equipment.weapon ? player.equipment.weapon.displayName : 'ãªã—';
            document.getElementById('armor').textContent = 
                player.equipment.armor ? player.equipment.armor.displayName : 'ãªã—';
            document.getElementById('accessory1').textContent = 
                player.equipment.accessory1 ? player.equipment.accessory1.displayName : 'ãªã—';
            document.getElementById('accessory2').textContent = 
                player.equipment.accessory2 ? player.equipment.accessory2.displayName : 'ãªã—';
        }

        // ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨ˆç®—
        function calculateTotalStats() {
            const player = gameState.player;
            let totalAttack = player.baseAttack;
            let totalMagic = player.baseMagic;
            let totalHp = player.maxHp;
            let totalMp = player.maxMp;
            
            Object.values(player.equipment).forEach(item => {
                if (item) {
                    totalAttack += item.attack || 0;
                    totalMagic += item.magic || 0;
                    totalHp += item.hp || 0;
                    totalMp += item.mp || 0;
                }
            });
            
            return {attack: totalAttack, magic: totalMagic, hp: totalHp, mp: totalMp};
        }

        // ç§»å‹•
        function move(direction) {
            if (gameState.inCombat || gameState.showingEquipMenu || gameState.showingMagicMenu) return;
            
            let newX = gameState.player.x;
            let newY = gameState.player.y;
            
            switch(direction) {
                case 'north': newY--; break;
                case 'south': newY++; break;
                case 'east': newX++; break;
                case 'west': newX--; break;
            }
            
            if (newX < 0 || newX >= 5 || newY < 0 || newY >= 5) {
                addLog("ãã¡ã‚‰ã¸ã¯é€²ã‚ã¾ã›ã‚“ã€‚");
                return;
            }
            
            gameState.player.x = newX;
            gameState.player.y = newY;
            
            const currentRoom = gameState.dungeon[newY][newX];
            currentRoom.visited = true;
            
            addLog(`${direction}ã¸ç§»å‹•ã—ã¾ã—ãŸã€‚`);
            
            if (currentRoom.isBossRoom && !gameState.inCombat) {
                addLog("ã¤ã„ã«æœ€æ·±éƒ¨ã«åˆ°é”ã—ãŸï¼å·¨å¤§ãªãƒ‰ãƒ©ã‚´ãƒ³ãŒç«‹ã¡ã¯ã ã‹ã‚‹ï¼");
                startCombat(monsters[4]); // ãƒœã‚¹æˆ¦
            } else if (currentRoom.hasMonster && Math.random() < 0.6) {
                const monsterIndex = Math.floor(Math.random() * 4);
                startCombat(monsters[monsterIndex]);
            } else if (currentRoom.hasTreasure) {
                findTreasure();
                currentRoom.hasTreasure = false;
            }
            
            displayMap();
        }

        // éƒ¨å±‹ã‚’èª¿ã¹ã‚‹
        function searchRoom() {
            if (gameState.inCombat || gameState.showingEquipMenu || gameState.showingMagicMenu) return;
            
            const currentRoom = gameState.dungeon[gameState.player.y][gameState.player.x];
            
            if (currentRoom.hasTreasure) {
                findTreasure();
                currentRoom.hasTreasure = false;
            } else if (currentRoom.hasMonster && Math.random() < 0.4) {
                const monsterIndex = Math.floor(Math.random() * 4);
                addLog("ä½•ã‹ãŒæ½œã‚“ã§ã„ã‚‹...");
                startCombat(monsters[monsterIndex]);
            } else {
                addLog("ç‰¹ã«ä½•ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã€‚");
            }
        }

        // å®ç®±ç™ºè¦‹
        function findTreasure() {
            addLog("å®ç®±ã‚’ç™ºè¦‹ã—ãŸï¼");
            generateRandomEquipment();
        }

        // æˆ¦é—˜é–‹å§‹
        function startCombat(monsterTemplate) {
            gameState.inCombat = true;
            gameState.currentMonster = {
                ...monsterTemplate,
                maxHp: monsterTemplate.hp
            };
            
            document.getElementById('combatArea').classList.add('active');
            document.getElementById('movementButtons').style.display = 'none';
            
            addLog(`${gameState.currentMonster.name}ãŒç¾ã‚ŒãŸï¼`);
            updateMonsterDisplay();
        }

        // ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼è¡¨ç¤ºæ›´æ–°
        function updateMonsterDisplay() {
            const monster = gameState.currentMonster;
            document.getElementById('monsterInfo').innerHTML = 
                `${monster.name}<br>HP: ${monster.hp}/${monster.maxHp}`;
        }

        // æ”»æ’ƒ
        function attack() {
            if (!gameState.inCombat) return;
            
            const totalStats = calculateTotalStats();
            const damage = Math.max(1, totalStats.attack - 5 + Math.floor(Math.random() * 10));
            gameState.currentMonster.hp -= damage;
            
            addLog(`å‹‡è€…ã®æ”»æ’ƒï¼${gameState.currentMonster.name}ã«${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
            
            if (gameState.currentMonster.hp <= 0) {
                winCombat();
                return;
            }
            
            monsterTurn();
        }

        // é­”æ³•ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã
        function magic() {
            if (gameState.showingEquipMenu) return;
            
            gameState.showingMagicMenu = true;
            document.getElementById('magicMenu').classList.add('active');
            
            if (gameState.inCombat) {
                document.getElementById('combatArea').style.display = 'none';
            } else {
                document.getElementById('movementButtons').style.display = 'none';
            }
            
            updateSpellAvailability();
        }

        // é­”æ³•ä½¿ç”¨å¯èƒ½çŠ¶æ…‹ã®æ›´æ–°
        function updateSpellAvailability() {
            const spells = document.querySelectorAll('.spell-option');
            const player = gameState.player;
            
            // ãƒ•ã‚¡ã‚¤ã‚¢ (MP: 5)
            if (player.mp >= 5) {
                spells[0].classList.remove('disabled');
            } else {
                spells[0].classList.add('disabled');
            }
            
            // ãƒ’ãƒ¼ãƒ« (MP: 3)
            if (player.mp >= 3 && player.hp < player.maxHp) {
                spells[1].classList.remove('disabled');
            } else {
                spells[1].classList.add('disabled');
            }
            
            // ã‚µãƒ³ãƒ€ãƒ¼ (MP: 8)
            if (player.mp >= 8 && gameState.inCombat) {
                spells[2].classList.remove('disabled');
            } else {
                spells[2].classList.add('disabled');
            }
        }

        // é­”æ³•è© å”±
        function castSpell(spellType) {
            const player = gameState.player;
            
            switch(spellType) {
                case 'fire':
                    if (player.mp < 5) {
                        addLog("MPãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
                        return;
                    }
                    if (!gameState.inCombat) {
                        addLog("æˆ¦é—˜ä¸­ä»¥å¤–ã§ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ï¼");
                        return;
                    }
                    
                    player.mp -= 5;
                    const totalStats = calculateTotalStats();
                    const damage = Math.max(3, totalStats.magic + Math.floor(Math.random() * 8));
                    gameState.currentMonster.hp -= damage;
                    
                    addLog(`ãƒ•ã‚¡ã‚¤ã‚¢ï¼${gameState.currentMonster.name}ã«${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
                    
                    closeMagicMenu();
                    
                    if (gameState.currentMonster.hp <= 0) {
                        winCombat();
                        return;
                    }
                    
                    monsterTurn();
                    break;
                    
                case 'heal':
                    if (player.mp < 3) {
                        addLog("MPãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
                        return;
                    }
                    if (player.hp >= player.maxHp) {
                        addLog("HPã¯æº€ã‚¿ãƒ³ã§ã™ï¼");
                        return;
                    }
                    
                    player.mp -= 3;
                    const totalStats2 = calculateTotalStats();
                    const healAmount = Math.max(15, Math.floor(totalStats2.magic * 1.5) + Math.floor(Math.random() * 10));
                    const actualHeal = Math.min(healAmount, player.maxHp - player.hp);
                    player.hp += actualHeal;
                    
                    addLog(`ãƒ’ãƒ¼ãƒ«ï¼HPãŒ${actualHeal}å›å¾©ã—ãŸï¼`);
                    
                    closeMagicMenu();
                    
                    if (gameState.inCombat) {
                        monsterTurn();
                    }
                    break;
                    
                case 'thunder':
                    if (player.mp < 8) {
                        addLog("MPãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
                        return;
                    }
                    if (!gameState.inCombat) {
                        addLog("æˆ¦é—˜ä¸­ä»¥å¤–ã§ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ï¼");
                        return;
                    }
                    
                    player.mp -= 8;
                    const totalStats3 = calculateTotalStats();
                    const thunderDamage = Math.max(8, Math.floor(totalStats3.magic * 1.8) + Math.floor(Math.random() * 12));
                    gameState.currentMonster.hp -= thunderDamage;
                    
                    addLog(`ã‚µãƒ³ãƒ€ãƒ¼ï¼å¼·åŠ›ãªé›·æ’ƒãŒ${gameState.currentMonster.name}ã‚’è¥²ã†ï¼${thunderDamage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
                    
                    closeMagicMenu();
                    
                    if (gameState.currentMonster.hp <= 0) {
                        winCombat();
                        return;
                    }
                    
                    monsterTurn();
                    break;
            }
        }

        // é­”æ³•ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        function closeMagicMenu() {
            gameState.showingMagicMenu = false;
            document.getElementById('magicMenu').classList.remove('active');
            
            if (gameState.inCombat) {
                document.getElementById('combatArea').style.display = 'block';
            } else if (!gameState.showingEquipMenu) {
                document.getElementById('movementButtons').style.display = 'flex';
            }
            
            updateDisplay();
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ä½¿ç”¨ï¼ˆç°¡æ˜“å›å¾©ï¼‰
        function useItem() {
            if (!gameState.inCombat) return;
            
            const healAmount = 20;
            gameState.player.hp = Math.min(gameState.player.maxHp, gameState.player.hp + healAmount);
            addLog(`è–¬è‰ã‚’ä½¿ç”¨ï¼HPãŒ${healAmount}å›å¾©ã—ãŸï¼`);
            
            monsterTurn();
        }

        // é€ƒèµ°
        function flee() {
            if (!gameState.inCombat) return;
            
            if (gameState.currentMonster.name.includes("ãƒœã‚¹")) {
                addLog("ãƒœã‚¹ã‹ã‚‰ã¯é€ƒã’ã‚‰ã‚Œãªã„ï¼");
                monsterTurn();
                return;
            }
            
            if (Math.random() < 0.7) {
                addLog("é€ƒèµ°æˆåŠŸï¼");
                endCombat();
            } else {
                addLog("é€ƒã’åˆ‡ã‚Œãªã‹ã£ãŸï¼");
                monsterTurn();
            }
        }

        // ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®ã‚¿ãƒ¼ãƒ³
        function monsterTurn() {
            updateMonsterDisplay();
            updateDisplay();
            
            setTimeout(() => {
                const monster = gameState.currentMonster;
                const damage = Math.max(1, monster.attack - 3 + Math.floor(Math.random() * 6));
                gameState.player.hp -= damage;
                
                addLog(`${monster.name}ã®æ”»æ’ƒï¼å‹‡è€…ã«${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
                
                if (gameState.player.hp <= 0) {
                    gameOver();
                } else {
                    updateDisplay();
                }
            }, 1000);
        }

        // æˆ¦é—˜å‹åˆ©
        function winCombat() {
            const monster = gameState.currentMonster;
            gameState.player.exp += monster.exp;
            
            addLog(`${monster.name}ã‚’å€’ã—ãŸï¼çµŒé¨“å€¤${monster.exp}ã‚’ç²å¾—ï¼`);
            
            // ãƒ‰ãƒ­ãƒƒãƒ—åˆ¤å®š
            if (Math.random() < monster.dropRate) {
                generateRandomEquipment();
            }
            
            // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—åˆ¤å®š
            if (gameState.player.exp >= gameState.player.expToNext) {
                levelUp();
            }
            
            // ãƒœã‚¹å‹åˆ©åˆ¤å®š
            if (monster.name.includes("ãƒœã‚¹")) {
                addLog("ğŸ‰ ãŠã‚ã§ã¨ã†ï¼ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã‚’åˆ¶è¦‡ã—ã¾ã—ãŸï¼ ğŸ‰");
            }
            
            endCombat();
        }

        // æˆ¦é—˜çµ‚äº†
        function endCombat() {
            gameState.inCombat = false;
            gameState.currentMonster = null;
            
            document.getElementById('combatArea').classList.remove('active');
            document.getElementById('movementButtons').style.display = 'flex';
            
            updateDisplay();
        }

        // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—
        function levelUp() {
            gameState.player.level++;
            gameState.player.exp -= gameState.player.expToNext;
            gameState.player.expToNext = Math.floor(gameState.player.expToNext * 1.5);
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸Šæ˜‡
            const hpInc = 10 + Math.floor(Math.random() * 5);
            const mpInc = 5 + Math.floor(Math.random() * 3);
            const attInc = 3 + Math.floor(Math.random() * 3);
            const magInc = 2 + Math.floor(Math.random() * 2);
            
            gameState.player.maxHp += hpInc;
            gameState.player.hp = gameState.player.maxHp; // å…¨å›å¾©
            gameState.player.maxMp += mpInc;
            gameState.player.mp = gameState.player.maxMp;
            gameState.player.baseAttack += attInc;
            gameState.player.baseMagic += magInc;
            
            addLog(`ğŸŒŸ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ Lv.${gameState.player.level} ã«ãªã£ãŸï¼`);
            addLog(`HP+${hpInc}, MP+${mpInc}, ç‰©ç†åŠ›+${attInc}, é­”æ³•åŠ›+${magInc}`);
        }

        // ãƒ©ãƒ³ãƒ€ãƒ è£…å‚™ç”Ÿæˆ
        function generateRandomEquipment() {
            const equipTypes = ['weapon', 'armor', 'accessory'];
            const equipType = equipTypes[Math.floor(Math.random() * equipTypes.length)];
            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            
            let baseItem;
            if (equipType === 'weapon') {
                baseItem = baseEquipment.weapon[Math.floor(Math.random() * baseEquipment.weapon.length)];
            } else if (equipType === 'armor') {
                baseItem = baseEquipment.armor[Math.floor(Math.random() * baseEquipment.armor.length)];
            } else {
                baseItem = baseEquipment.accessory[Math.floor(Math.random() * baseEquipment.accessory.length)];
            }
            
            const newItem = {
                type: equipType,
                displayName: prefix.name + baseItem.name,
                hp: (baseItem.hp || 0) + prefix.hp,
                mp: (baseItem.mp || 0) + prefix.mp,
                attack: (baseItem.attack || 0) + prefix.attack,
                magic: (baseItem.magic || 0) + prefix.magic
            };
            
            addLog(`${newItem.displayName}ã‚’ç™ºè¦‹ã—ãŸï¼`);
            offerEquipment(newItem);
        }

        // è£…å‚™å¤‰æ›´ææ¡ˆ
        function offerEquipment(newItem) {
            gameState.pendingItem = newItem;
            gameState.showingEquipMenu = true;
            
            document.getElementById('equipmentMenu').classList.add('active');
            document.getElementById('movementButtons').style.display = 'none';
            
            showNewItemStats(newItem);
            updateEquipButtons(newItem);
            
            addLog(`${newItem.displayName}ã‚’å…¥æ‰‹ï¼è£…å‚™ã—ã¾ã™ã‹ï¼Ÿ`);
        }

        // æ–°ã‚¢ã‚¤ãƒ†ãƒ ã®è©³ç´°è¡¨ç¤º
        function showNewItemStats(item) {
            let statsHtml = `<div class="new-item-stats">
                <strong>${item.displayName}</strong><br>`;
            
            if (item.hp !== 0) statsHtml += `HP: ${item.hp > 0 ? '+' : ''}${item.hp}<br>`;
            if (item.mp !== 0) statsHtml += `MP: ${item.mp > 0 ? '+' : ''}${item.mp}<br>`;
            if (item.attack !== 0) statsHtml += `ç‰©ç†åŠ›: ${item.attack > 0 ? '+' : ''}${item.attack}<br>`;
            if (item.magic !== 0) statsHtml += `é­”æ³•åŠ›: ${item.magic > 0 ? '+' : ''}${item.magic}<br>`;
            
            statsHtml += '</div>';
            
            // ç¾åœ¨ã®è£…å‚™ã¨ã®æ¯”è¼ƒ
            const slots = item.type === 'accessory' ? ['accessory1', 'accessory2'] : [item.type];
            
            slots.forEach(slot => {
                const currentItem = gameState.player.equipment[slot];
                if (currentItem) {
                    statsHtml += `<div class="stat-comparison">
                        ç¾åœ¨ã®${slot === 'accessory1' ? 'ã‚¢ã‚¯ã‚»1' : slot === 'accessory2' ? 'ã‚¢ã‚¯ã‚»2' : 
                                   slot === 'weapon' ? 'æ­¦å™¨' : 'é˜²å…·'}: ${currentItem.displayName}
                    </div>`;
                    
                    statsHtml += compareStats(currentItem, item);
                }
            });
            
            document.getElementById('newItemDisplay').innerHTML = statsHtml;
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ¯”è¼ƒè¡¨ç¤º
        function compareStats(oldItem, newItem) {
            let comparison = '<div class="stat-comparison">';
            
            ['hp', 'mp', 'attack', 'magic'].forEach(stat => {
                const oldVal = oldItem[stat] || 0;
                const newVal = newItem[stat] || 0;
                const diff = newVal - oldVal;
                
                if (diff !== 0) {
                    const statName = stat === 'attack' ? 'ç‰©ç†åŠ›' : stat === 'magic' ? 'é­”æ³•åŠ›' : stat.toUpperCase();
                    const diffClass = diff > 0 ? 'stat-up' : 'stat-down';
                    comparison += `<span class="${diffClass}">${statName}: ${diff > 0 ? '+' : ''}${diff}</span><br>`;
                }
            });
            
            comparison += '</div>';
            return comparison;
        }

        // è£…å‚™ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ¶å¾¡
        function updateEquipButtons(item) {
            const buttons = document.querySelectorAll('.equip-buttons button');
            buttons.forEach(btn => btn.style.display = 'inline-block');
            
            if (item.type === 'weapon') {
                buttons[1].style.display = 'none'; // é˜²å…·ãƒœã‚¿ãƒ³éš ã™
                buttons[2].style.display = 'none'; // ã‚¢ã‚¯ã‚»1ãƒœã‚¿ãƒ³éš ã™
                buttons[3].style.display = 'none'; // ã‚¢ã‚¯ã‚»2ãƒœã‚¿ãƒ³éš ã™
            } else if (item.type === 'armor') {
                buttons[0].style.display = 'none'; // æ­¦å™¨ãƒœã‚¿ãƒ³éš ã™
                buttons[2].style.display = 'none'; // ã‚¢ã‚¯ã‚»1ãƒœã‚¿ãƒ³éš ã™
                buttons[3].style.display = 'none'; // ã‚¢ã‚¯ã‚»2ãƒœã‚¿ãƒ³éš ã™
            } else if (item.type === 'accessory') {
                buttons[0].style.display = 'none'; // æ­¦å™¨ãƒœã‚¿ãƒ³éš ã™
                buttons[1].style.display = 'none'; // é˜²å…·ãƒœã‚¿ãƒ³éš ã™
            }
        }

        // ã‚¢ã‚¤ãƒ†ãƒ è£…å‚™
        function equipItem(slot) {
            if (!gameState.pendingItem) return;
            
            const oldItem = gameState.player.equipment[slot];
            gameState.player.equipment[slot] = gameState.pendingItem;
            
            if (oldItem) {
                addLog(`${oldItem.displayName}ã‚’å¤–ã—ã¾ã—ãŸã€‚`);
            }
            
            addLog(`${gameState.pendingItem.displayName}ã‚’è£…å‚™ã—ã¾ã—ãŸï¼`);
            
            // HPã¨MPã®æœ€å¤§å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
            const totalStats = calculateTotalStats();
            if (gameState.player.hp > totalStats.hp) {
                gameState.player.hp = totalStats.hp;
            }
            if (gameState.player.mp > totalStats.mp) {
                gameState.player.mp = totalStats.mp;
            }
            gameState.player.maxHp = totalStats.hp;
            gameState.player.maxMp = totalStats.mp;
            
            closeEquipMenu();
        }

        // ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¨ã¦ã‚‹
        function discardItem() {
            if (!gameState.pendingItem) return;
            
            addLog(`${gameState.pendingItem.displayName}ã‚’æ¨ã¦ã¾ã—ãŸã€‚`);
            closeEquipMenu();
        }

        // è£…å‚™ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        function closeEquipMenu() {
            gameState.showingEquipMenu = false;
            gameState.pendingItem = null;
            
            document.getElementById('equipmentMenu').classList.remove('active');
            if (!gameState.inCombat) {
                document.getElementById('movementButtons').style.display = 'flex';
            }
            
            updateDisplay();
        }

        // è£…å‚™ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
        function showInventory() {
            if (gameState.showingMagicMenu) return;
            
            addLog("=== ç¾åœ¨ã®è£…å‚™ ===");
            const totalStats = calculateTotalStats();
            
            addLog(`ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: HP${totalStats.hp} MP${totalStats.mp} ç‰©ç†åŠ›${totalStats.attack} é­”æ³•åŠ›${totalStats.magic}`);
            addLog(`æ­¦å™¨: ${gameState.player.equipment.weapon?.displayName || 'ãªã—'}`);
            addLog(`é˜²å…·: ${gameState.player.equipment.armor?.displayName || 'ãªã—'}`);
            addLog(`ã‚¢ã‚¯ã‚»1: ${gameState.player.equipment.accessory1?.displayName || 'ãªã—'}`);
            addLog(`ã‚¢ã‚¯ã‚»2: ${gameState.player.equipment.accessory2?.displayName || 'ãªã—'}`);
        }

        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
        function gameOver() {
            addLog("ğŸ’€ GAME OVER ğŸ’€");
            addLog("å‹‡è€…ã¯åŠ›å°½ããŸ...");
            // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
            setTimeout(() => {
                if (confirm("ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¾ã™ã‹ï¼Ÿ")) {
                    location.reload();
                }
            }, 2000);
        }

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        function initGame() {
            gameState.dungeon = generateDungeon();
            
            // åˆæœŸè£…å‚™ã‚’è£…å‚™
            gameState.player.equipment.weapon = startingEquipment.weapon;
            gameState.player.equipment.armor = startingEquipment.armor;
            gameState.player.equipment.accessory1 = startingEquipment.accessory;
            
            // åˆæœŸè£…å‚™ã‚’å«ã‚ãŸç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§HP/MPã‚’å†è¨ˆç®—
            const totalStats = calculateTotalStats();
            gameState.player.maxHp = totalStats.hp;
            gameState.player.maxMp = totalStats.mp;
            gameState.player.hp = gameState.player.maxHp;
            gameState.player.mp = gameState.player.maxMp;
            
            displayMap();
            updateDisplay();
            addLog("=== ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ãƒ»ã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹ ===");
            addLog("å‹‡è€…ã‚ˆã€ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®å¥¥ã«æ½œã‚€ãƒœã‚¹ã‚’å€’ã™ã®ã ï¼");
            addLog("ç§»å‹•ã¯æ–¹å‘ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚");
            addLog("é­”æ³•ï¼šãƒ•ã‚¡ã‚¤ã‚¢(æ”»æ’ƒ), ãƒ’ãƒ¼ãƒ«(å›å¾©), ã‚µãƒ³ãƒ€ãƒ¼(å¼·æ”»æ’ƒ)");
            addLog("â”â”â” åˆæœŸè£…å‚™ â”â”â”");
            addLog("æœ¨ã®å‰£ (ç‰©ç†åŠ›+8) ã‚’è£…å‚™");
            addLog("å¸ƒã®æœ (HP+10, MP+2, é­”æ³•åŠ›+1) ã‚’è£…å‚™");
            addLog("é©ã®è…•è¼ª (HP+5, ç‰©ç†åŠ›+2) ã‚’è£…å‚™");
            
            // æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤º
            const finalStats = calculateTotalStats();
            addLog(`ç·åˆåŠ›: HP${finalStats.hp} MP${finalStats.mp} ç‰©ç†åŠ›${finalStats.attack} é­”æ³•åŠ›${finalStats.magic}`);
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        initGame();
    </script>
</body>
</html>